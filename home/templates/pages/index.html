{% extends 'layouts/base.html' %}

{% block content %}
    <!-- Header content -->
    <div id="stepper-wrapper" class="stepper-wrapper">
        <div class="stepper-item" data-counter="1">
            <div class="step-counter">1</div>
            <div class="step-name">Akkuvariante</div>
        </div>
        <div class="stepper-item" data-counter="2">
            <div class="step-counter">2</div>
            <div class="step-name">Kabelvariante</div>
        </div>
        <div class="stepper-item" data-counter="3">
            <div class="step-counter">3</div>
            <div class="step-name">Schnittstelle</div>
        </div>
        <div class="stepper-item" data-counter="4">
            <div class="step-counter">4</div>
            <div class="step-name">Maße</div>
        </div>
    </div>

    <!-- Custom Solution Selector -->
    <div id="CustomSolution-Section">
        <div class="space space-2"></div>
        <section>
            <div>
                <p style="text-align: center; color:white;">
                    Konfigurieren Sie Ihre persönliche Kabellösung zur Stromversorgung von AES Akkus
                </p>
            </div>
        </section>
        <div class="space space-2"></div>
        <div style="text-align: center;">
            <button class="next-button" onclick="goToSection('Akkuvariante-Section')">Weiter zum Konfigurator</button>
            <button class="next-button" onclick="goToSection('Zusammenfassung-Section')">Hochladen von Sonderlösungen</button>
        </div>
    </div>

    <!-- Akkuvariante Selector -->
    <div id="Akkuvariante-Section">
        <!-- <div class="space space-2"></div> -->
        <section class="layoutblock lb-10col-width lb-hinweisausgabe">
            <div class="content anlauf_text">
                <p style="text-align: center;">
                    Akkuvariante
                </p>
            </div>
        </section>
        <div class="space space-2"></div>
        <div class="akkuvariante-selectors-container">
            {% for akkuvariante in akkuvarianten %}
                <div class="akkuvariante-selector" onclick="selectAkkuvariante('{{ akkuvariante.akkuvariante_name }}')">
                    <label>{{ akkuvariante.akkuvariante_name }}</label>
                    <img src="media\{{ akkuvariante.akkuvariante_image_path }}" alt="{{ akkuvariante.akkuvariante_name }}">
                </div>
            {% empty %}
                <p>No Akkuvarianten available.</p>
            {% endfor %}
            <div class="space space-2"></div>
            <p>Mit 120 Ohm CAN-Bus Widerstand?</p>
            <div>
                <label for="ja-nein-option">Ja</label>
                <input type="radio" id="ja-nein-option" name="ja-nein-option" value="ja">
                <label for="ja-nein-option">Nein</label>
                <input type="radio" id="ja-nein-option" name="ja-nein-option" value="nein">
            </div>
        </div>
        <div class="space space-2"></div>
        <div style="text-align: center;">
            <button class="next-button" onclick="goToSection('Kabelvariante-Section')">Nächste</button>
        </div>
    </div>

    <!-- Kabelvariante Selector -->
    <div id="Kabelvariante-Section">
        <!-- <div class="space space-2"></div> -->
        <section class="layoutblock lb-10col-width lb-hinweisausgabe">
            <div class="content anlauf_text">
                <p style="text-align: center;">
                    Kabelvariante
                </p>
            </div>
        </section>
        <div class="space space-2"></div>
        <div class="kabelvariante-selectors-container">
            <!-- {% for kabelvariante in kabelvarianten %}
                <div class="kabelvariante-selector" onclick="selectKabelvariante('{{ kabelvariante.kabelvariante_name }}')">
                    <label>{{ kabelvariante.kabelvariante_name }}</label>
                    <img src="media\{{ kabelvariante.kabelvariante_image_path }}" alt="{{ kabelvariante.kabelvariante_name }}">
                </div>
            {% empty %}
                <p>No Kabelvarianten available.</p>
            {% endfor %} -->
        </div>
        <div class="space space-2"></div>
        <div style="text-align: center;">
            <button class="prev-button" onclick="goToSection('Akkuvariante-Section')">Zuruck</button>
            <button class="next-button" onclick="goToSection('Schnittstellen-Section')">Nächste</button>
        </div>
    </div>

    <!-- Schnittstellen Selector -->
    <div id="Schnittstellen-Section">
        <!-- <div class="space space-2"></div> -->
        <section class="layoutblock lb-10col-width lb-hinweisausgabe">
            <div class="content anlauf_text">
                <p style="text-align: center;">
                    Schnittstellen
                </p>
            </div>
        </section>
        <div class="space space-2"></div>
        {% load custom_filters %}
        <div id="schnittstelle-slider-container">
            {% for kabelvariante in kabelvarianten %}
                <div class="schnittstelle-slider-container-class" id="{{ kabelvariante.kabelvariante_name|slugify }}-schnittstelle-slider">
                    <img class="schnittstelle-image" src="media\{{ kabelvariante.masse_image_path }}">
                    {% if kabelvariante.splits > 1 %}
                        {% with splits=kabelvariante.splits %}
                            {% for i in splits|create_range_schnittstellen %}
                                <div class="schnittstelle-row">
                                    <div class="schnittstelle-heading">
                                        <div class="schnittstelle-heading-option">Schnittstelle S{{ i }}</div>
                                    </div>
                                    <div class="schnittstelle-selectors">
                                        {% for schnittstelle in schnittstellen %}
                                            <div class="schnittstelle-selector" id="{{ schnittstelle.schnittstelle_name|slugify }}-S{{ i }}" data-split-index="{{ i }}" onclick="selectschnittstellenvariante('{{ schnittstelle.schnittstelle_name }}', '{{ i }}')">
                                                <label>{{ schnittstelle.schnittstelle_name }}</label>
                                                <img src="media\{{ schnittstelle.schnittstelle_image_path }}" alt="{{ schnittstelle.schnittstelle_name }}">
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% endwith %}
                    {% elif kabelvariante.splits == 1 %}
                        <div class="schnittstelle-heading">
                            <div class="schnittstelle-heading-option">Schnittstelle S</div>
                        </div>
                        <div class="schnittstelle-selectors">
                            {% for schnittstelle in schnittstellen %}
                                <div class="schnittstelle-selector" id="{{ schnittstelle.schnittstelle_name|slugify }}-S" data-split-index="S" onclick="selectschnittstellenvariante('{{ schnittstelle.schnittstelle_name }}', 'S')">
                                    <label>{{ schnittstelle.schnittstelle_name }}</label>
                                    <img src="media\{{ schnittstelle.schnittstelle_image_path }}" alt="{{ schnittstelle.schnittstelle_name }}">
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>No valid Kabelvarianten available.</p>
                    {% endif %}
                </div>
            {% empty %}
                <p>No Kabelvarianten available.</p>
            {% endfor %}
        </div>
        <div class="space space-2"></div>
        <div style="text-align: center;">
            <button class="prev-button" onclick="goToSection('Kabelvariante-Section')">Zuruck</button>
            <button class="next-button" onclick="goToSection('Masse-Section')">Nächste</button>
        </div>
    </div>

    <!-- Maße Slider Container -->
    <div id="Masse-Section">
        <!-- <div class="space space-2"></div> -->
        <section class="layoutblock lb-10col-width lb-hinweisausgabe">
            <div class="content anlauf_text">
                <p style="text-align: center;">
                    Maße
                </p>
            </div>
        </section>
        <div class="space space-2"></div>
        <div id="masse-slider-container">
            {% for kabelvariante in kabelvarianten %}
                <div class="masse-slider-container-class" id="{{ kabelvariante.kabelvariante_name|slugify }}-messe-slider">
                    <img class="masse-image" src="media\{{ kabelvariante.masse_image_path }}">
                    {% if kabelvariante.splits > 1 %}
                        <div class="input-pair">
                            <label for="{{ kabelvariante.kabelvariante_name|slugify }}-main-length">Main Length (cm): </label>
                            <input type="number" id="{{ kabelvariante.kabelvariante_name|slugify }}-main-length" min="{{ kabelvariante.main_part_min_length }}" max="{{ kabelvariante.main_part_max_length }}" step="1" value="{{ kabelvariante.main_part_min_length }}" oninput="masseChange(this.value)">
                        </div>
                        {% for i in kabelvariante.splits|create_range_masse %}
                            <div class="input-pair">
                                <label for="{{ kabelvariante.kabelvariante_name|slugify }}-branch{{ forloop.counter }}-length">Branch {{ forloop.counter }} Length (cm): </label>
                                <input type="number" id="{{ kabelvariante.kabelvariante_name|slugify }}-branch{{ forloop.counter }}-length" min="{{ kabelvariante.split_part_min_length }}" max="{{ kabelvariante.split_part_max_length }}" step="1" value="{{ kabelvariante.split_part_min_length }}" oninput="masseChange(this.value)">
                            </div>
                        {% endfor %}
                    {% elif kabelvariante.splits == 1 %}
                        <div class="input-pair">
                            <label for="{{ kabelvariante.kabelvariante_name|slugify }}-main-length-input">Main length (cm):</label>
                            <input type="number" id="{{ kabelvariante.kabelvariante_name|slugify }}-main-length-input" min="{{ kabelvariante.main_part_min_length }}" max="{{ kabelvariante.main_part_max_length }}" step="1" value="{{ kabelvariante.main_part_min_length }}" oninput="masseChange(this.value)">
                        </div>
                    {% else %}
                        <p>No valid Kabelvarianten available.</p>
                    {% endif %}
                </div>
            {% empty %}
                <p>No Kabelvarianten available.</p>
            {% endfor %}
        </div>
        <div class="space space-2"></div>
        <div style="text-align: center;">
            <button class="prev-button" onclick="goToSection('Schnittstellen-Section')">Zuruck</button>
            <button class="next-button" onclick="goToSection('Zusammenfassung-Section')">Nächste</button>
        </div>
    </div>
        
    <!-- Zusammenfassung Container -->
    <div id="Zusammenfassung-Section">
        <!-- <div class="space space-2"></div> -->
        <section class="layoutblock lb-10col-width lb-hinweisausgabe">
            <div class="content anlauf_text">
                <p style="text-align: center;">
                    Zusammenfassung
                </p>
            </div>
        </section>
        <div class="space space-2"></div>
        <div id="summary-container">
            <label id="akkuvariante-summary">Akkuvariante: </label>
            <label id="kabelvariante-summary">Kabelvariante: </label>
            <label id="schnittstelle-summary">Schnittstelle: </label>
            <label id="masse-summary">Maße: </label>
            <label id="gesamtpreis-summary">Gesamtpreis: </label>
        </div>
        <div class="space space-2"></div>
        <div style="text-align: center;">
            <button class="prev-button" onclick="goToSection('Masse-Section')">Zuruck</button>
            <button class="next-button" onclick="addToCart()">Add to Cart</button>
        </div>
    </div>

    <div class="space space-2"></div>

    <input id="filteredKabelvariantenInput">></input>

    <script>
        var akkuSelected = false;
        var kabelSelected = false;
        var schnittstellenSelected = false;
        var masseSelected = false;
        var selected_akkuvariante_name = "";
        var selected_kabel_name = "";
        var selected_schnittstellen_name = "";
        var selected_masse_name = "";
        var kabelvarianten = JSON.parse('{{ kabelvarianten | safe | escapejs }}');
        var kabelvarianten_names = JSON.parse('{{ kabelvarianten_namen | safe }}');
        var preisliste = JSON.parse('{{ preisliste | safe }}');

        goToSection('Akkuvariante-Section')
        updateProgressBar();
        
        function selectAkkuvariante(productName) {
            console.log('Selected Akkuvariante:', productName);

            var productSelectors = document.querySelectorAll('.akkuvariante-selector');

            productSelectors.forEach(function(selector) {
                selector.classList.remove('selected');
                var label = selector.querySelector('label');
                if (label.textContent.trim() === productName) {
                    selector.classList.add('selected');
                }
            });

            akkuSelected = true;
            selected_akkuvariante_name = productName;
            populateKabelvariantenSelectors(kabelvarianten); 
            updateProgressBar();
        }

        function selectKabelvariante(productName) {
            var productSelectors = document.querySelectorAll('.kabelvariante-selector');

            productSelectors.forEach(function(selector) {
                selector.classList.remove('selected');
                var label = selector.querySelector('label');
                if (label.textContent.trim() === productName) {
                    selector.classList.add('selected');
                }
            });

            masse(productName);
            schnittstelle(productName);
            kabelSelected = true;
            schnittstellenSelected = false;
            removeAllSelectedSchnittstellen()
            masseSelected = false;
            updateProgressBar();
        }

        function masse(productName){
            console.log('Selected Kabelvariante in masse:', productName);

            // Hide all sliders initially
            var sliders = document.querySelectorAll('.masse-slider-container-class');
            sliders.forEach(function(slider) {
                slider.classList.add('hidden');
            });

            // Show the selected slider based on cable type
            var selectedSliderId = productName.toLowerCase() + '-messe-slider';
            var selectedSlider = document.getElementById(selectedSliderId);
            if (selectedSlider) {
                selectedSlider.classList.remove('hidden');
            } else {
                console.log('No matching slider found for:', productName);
            }
        }

        function schnittstelle(productName){
            console.log('Selected Kabelvariante in Schnittstellen:', productName);
            selected_kabel_name = productName;

            // Hide all sliders initially
            var sliders = document.querySelectorAll('.schnittstelle-slider-container-class');
            sliders.forEach(function(slider) {
                slider.classList.add('hidden');
            });

            // Show the selected slider based on cable type
            var selectedSliderId = productName.toLowerCase() + '-schnittstelle-slider';
            var selectedSlider = document.getElementById(selectedSliderId);
            if (selectedSlider) {
                selectedSlider.classList.remove('hidden');
            } else {
                console.log('No matching slider found for:', productName);
            }

        }

        function selectschnittstellenvariante(productName, splitIndex) {
            console.log('Selected schnittstelle:', productName, splitIndex);

            var productSelectors = document.querySelectorAll('.schnittstelle-selector');

            productSelectors.forEach(function(selector) {
                if (splitIndex === 'S'){
                    var label = selector.querySelector('label');
                    var selectorSplitIndex = selector.getAttribute('data-split-index');
                    if (label.textContent.trim() === productName && selectorSplitIndex === splitIndex) {
                        selector.classList.add('selected');
                    }
                    if (label.textContent.trim() !== productName && selectorSplitIndex === splitIndex) {
                        selector.classList.remove('selected');
                    }
                }
                else{
                    for (var i = 0; i <= splitIndex; i++) {
                        var label = selector.querySelector('label');
                        var selectorSplitIndex = selector.getAttribute('data-split-index');
                        if (label.textContent.trim() === productName && selectorSplitIndex === splitIndex) {
                            selector.classList.add('selected');
                        }
                        if (label.textContent.trim() !== productName && selectorSplitIndex === splitIndex) {
                            selector.classList.remove('selected');
                        }
                    }
                }
            });

            schnittstellenSelected = true;
            updateProgressBar();
        }

        function removeAllSelectedSchnittstellen() {
            var selectors = document.querySelectorAll('.schnittstelle-selector');
            selectors.forEach(function (selector) {
                selector.classList.remove('selected');
            });
        }
        
        function updateSummary() {
            var akkuvariante = selected_akkuvariante_name;
            var kabelvariante = selected_kabel_name;
            var schnittstelle = selected_schnittstellen_name;
            var masse = selected_masse_name;

            document.getElementById('akkuvariante-summary').innerText = 'Akkuvariante: ' + akkuvariante;
            document.getElementById('kabelvariante-summary').innerText = 'Kabelvariante: ' + kabelvariante;
            document.getElementById('schnittstelle-summary').innerText = 'Schnittstelle: ' + schnittstelle;
            document.getElementById('masse-summary').innerText = 'Maße: ' + masse;
        }

        function masseChange(value) {
            masseSelected = true;
            updateProgressBar();
            console.log("Main Length changed to: " + value);
        }

        function goToSection(selectedSectionId) {
            var sections = [
                'Akkuvariante-Section',
                'Kabelvariante-Section',
                'Schnittstellen-Section',
                'Masse-Section',
                'Zusammenfassung-Section'
            ];

            for (var i = 0; i < sections.length; i++) {
                var sectionId = sections[i];
                var section = document.getElementById(sectionId);
                var stepperItem = document.querySelector('.stepper-item[data-counter="' + (i + 1) + '"]');

                if (section) {
                    if (i === 0) {
                        // For the first section (Akkuvariante-Section), scroll to the top of the page
                        if (i <= sections.indexOf(selectedSectionId)) {
                            section.classList.remove('hidden');
                            
                            if (stepperItem) {
                                stepperItem.classList.add('active');
                            }

                            // Auto-scroll to the top of the page
                            window.scrollTo({
                                top: 0,
                                behavior: 'smooth'
                            });
                        } else {
                            section.classList.add('hidden');
                            if (stepperItem && stepperItem.classList.contains('active')) {
                                stepperItem.classList.remove('active');
                            }
                        }
                    } else {
                        // For the rest of the sections, apply target position logic
                        if (i <= sections.indexOf(selectedSectionId)) {
                            section.classList.remove('hidden');

                            if (stepperItem) {
                                stepperItem.classList.add('active');
                            }

                            // Calculate the target position as 30% of the screen height
                            var targetPosition = section.offsetTop;

                            // Set the flag to indicate that scroll is triggered by goToSection
                            isScrollByGoToSection = true;

                            // Auto-scroll to the target position
                            window.scrollTo({
                                top: targetPosition,
                                behavior: 'smooth'
                            });
                        } else {
                            section.classList.add('hidden');
                            if (stepperItem && stepperItem.classList.contains('active')) {
                                stepperItem.classList.remove('active');
                            }
                        }
                    }
                } else {
                    console.error("Element with ID '" + sectionId + "' not found.");
                }
            }

            console.log("Going to the section: " + selectedSectionId);
        }

        function addToCart() {
            // Add logic to navigate to the next section
            // You can use JavaScript or any client-side framework/library for this
            console.log("Adding to cart");
        }

        function updateProgressBar() {
            // Update the stepper based on selected sections
            var stepperItems = document.querySelectorAll('.stepper-item');

            stepperItems[0].classList.toggle('completed', akkuSelected);
            stepperItems[1].classList.toggle('completed', kabelSelected);
            stepperItems[2].classList.toggle('completed', schnittstellenSelected);
            stepperItems[3].classList.toggle('completed', masseSelected);
        }

        function populateKabelvariantenSelectors(kabelvarianten) {
            var container = document.querySelector('.kabelvariante-selectors-container');
            container.innerHTML = "";
            var filteredKabelvarianten = [];

            for (let i = 0; i < preisliste.length; i++) {
                if (preisliste[i]["gehause"] === selected_akkuvariante_name) {
                    var preislist_kabelvariante = preisliste[i]["kabelvariante"];
                    if (!filteredKabelvarianten.includes(preislist_kabelvariante)) {
                        filteredKabelvarianten.push(preislist_kabelvariante);
                    }
                }
            }

            if (filteredKabelvarianten.length === 0) {
                // No Kabel options available, display a message
                var messageDiv = document.createElement('div');
                messageDiv.textContent = "No Kabel options available for the selected akkuvariante type.";
                container.appendChild(messageDiv);
            } else {
                kabelvarianten.forEach(function (kabelvariante) {
                    if (filteredKabelvarianten.includes(kabelvariante.kabelvariante_name)) {
                        var div = document.createElement('div');
                        div.className = 'kabelvariante-selector';
                        div.onclick = function () {
                            selectKabelvariante(kabelvariante.kabelvariante_name);
                        };

                        var label = document.createElement('label');
                        label.textContent = kabelvariante.kabelvariante_name;
                        div.appendChild(label);

                        var img = document.createElement('img');
                        img.src = "media\\" + kabelvariante.kabelvariante_image_path;
                        img.alt = kabelvariante.kabelvariante_name;
                        div.appendChild(img);

                        container.appendChild(div);
                    }
                });
            }
        }

    </script>
{% endblock %}