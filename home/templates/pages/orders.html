{% extends 'layouts/base.html' %}

{% block content %}
    {% with in_cart_items=in_cart_items %}
    {{block.super}}
    {% endwith %}
    {% load bootstrap_icons %}
    <div class="container mt-4">
        <h2 class="mt-4">Orders</h2>
        <form id="deleteOrderForm" method="post">
            {% csrf_token %}
            <input type="hidden" name="order_number" id="deleteOrderNumber">
        </form>
        <div class="accordion m-3" id="ordersAccordion">
            {% for order in orders %}
            <div class="container order-row m-2 p-0" data-order-number="{{ order.order_number }}" data-total="{{ order.total }}">
                <div class="accordion-item col p-0">
                    <div class="accordion-header" id="heading{{ order.order_number }}">
                        <div class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ order.order_number }}" aria-expanded="false" aria-controls="collapse{{ order.order_number }}">
                            <div class="container">
                                <div class="row">
                                    <span class="col">
                                        <h4>Order #{{ order.order_number }}</h4>
                                    </span>
                                    <span class="col">
                                        <div class="container">
                                            <small class="row text-uppercase fw-light">Order Date</small>
                                            <b class="row order-date bold">{{ order.order_date }}</b>
                                        </div>
                                    </span>
                                    <span class="col">
                                        <div class="container">
                                            <small class="row text-uppercase fw-light">Total</small>
                                            <b class="row total bold">€{{ order.total }}</b>
                                        </div>
                                    </span>
                                    <span class="col">
                                        <div class="container">
                                            <small class="row text-uppercase fw-light">Status</small>
                                            <b class="row order-date bold">{{ order.order_status }}</b>
                                        </div>
                                    </span>
                                    <span class="col">
                                        {% if order.order_status == 'Ordered' %}
                                            <button type="button" class="btn btn-outline-info cancel-order" data-toggle="modal" data-target="#cancelOrderModal">Cancel</button>
                                        {% elif order.order_status == 'Cancelled' %}
                                            <button type="button" class="btn btn-outline-info order-again" data-toggle="modal" data-target="#orderAgainModal">Order Again</button>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="collapse{{ order.order_number }}" class="accordion-collapse collapse" aria-labelledby="heading{{ order.order_number }}" data-bs-parent="#ordersAccordion">
                        <div class="container">
                            <div class="accordion m-3 row" id="orderItemsAccordion">
                                {% for item in order.items %}
                                <div class="container item-row m-2 p-0" data-item-number="{{ item.item_number }}" data-price="{{ item.price }}">
                                    <div class="accordion-item col p-0">
                                        <div class="accordion-header" id="itemHeading{{ item.item_number }}">
                                            <div class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ item.item_number }}" aria-expanded="false" aria-controls="collapse{{ item.item_number }}">
                                                <div class="container">
                                                    <div class="row">
                                                        <span class="col">
                                                            <h4>Item #{{ item.item_number }}</h4>
                                                        </span>
                                                        <span class="col">
                                                            <div class="container">
                                                                <small class="row text-uppercase fw-light">Price</small>
                                                                <b class="row price bold">€{{ item.price }}</b>
                                                            </div>
                                                        </span>
                                                        <span class="col">
                                                            <div class="container">
                                                                <small class="row text-uppercase fw-light">Quantity</small>
                                                                <b class="row quantity">{{ item.quantity }}</b>
                                                            </div>
                                                        </span>
                                                        <span class="col">
                                                            <div class="container">
                                                                <small class="row text-uppercase fw-light">Total Price</small>
                                                                <b class="row total-price">€{{ item.total }}</b>
                                                            </div>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="collapse{{ item.item_number }}" class="accordion-collapse collapse" aria-labelledby="heading{{ item.item_number }}" data-bs-parent="#orderItemsAccordion">
                                            <div class="accordion-body">
                                                Akkuvariante: <span class="item-akkuvariante">{{ item.akkuvariante }}</span>
                                            </div>
                                            <div class="accordion-body">
                                                Mit 120 Ohm CAN-Bus Widerstand?: <span class="item-CAN-Bus">{{ item.mit_120_Ohm_CAN_Bus_Widerstand }}</span>
                                            </div>
                                            <div class="accordion-body">
                                                Kabelvariante: <span class="item-kabelvariante">{{ item.kabelvariante }}</span>
                                            </div>
                                            <div class="accordion-body">
                                                Schnittstelle: <span class="item-schnittstelle">{{ item.schnittstelle }}</span>
                                            </div>
                                            <div class="accordion-body">
                                                Masse: <span class="item-masse">{{ item.masse }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% if not orders %}
                <div class="text-center m-5">No orders for user.</div>
            {% endif %}
        </div>

        <!-- Pagination -->
        <div class="pagination">
            <span class="step-links">
                {% if orders.has_previous %}
                    <a href="?page=1">&laquo; first</a>
                    <a href="?page={{ orders.previous_page_number }}">previous</a>
                {% endif %}

                <span class="current">
                    Page {{ orders.number }} of {{ orders.paginator.num_pages }}.
                </span>

                {% if orders.has_next %}
                    <a href="?page={{ orders.next_page_number }}">next</a>
                    <a href="?page={{ orders.paginator.num_pages }}">last &raquo;</a>
                {% endif %}
            </span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Event listener for the cancel order button
            document.getElementById('ordersAccordion').addEventListener('click', function (event) {
                if (event.target.classList.contains('cancel-order')) {
                    var orderRow = event.target.closest('.order-row');
                    var orderNumber = orderRow.dataset.orderNumber;

                    // Prompt user for confirmation
                    if (confirm("Are you sure you want to cancel this order?")) {
                        // If confirmed, trigger UPDATE request to cancel the order
                        fetch('/cancel_order/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}',  // Include CSRF token for Django
                            },
                            body: JSON.stringify({'order_number': orderNumber}),
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            location.reload();
                        })
                        .catch(error => {
                            console.error('Error cancelling order:', error);
                        });
                    }
                }
            });

            // Event listener for the order again button
            document.getElementById('ordersAccordion').addEventListener('click', function (event) {
                if (event.target.classList.contains('order-again')) {
                    var orderRow = event.target.closest('.order-row');
                    var orderNumber = orderRow.dataset.orderNumber;

                    // Prompt user for confirmation
                    if (confirm("Are you sure you want to order this again?")) {
                        // If confirmed, trigger UPDATE request to update the order to 'Ordered'
                        fetch('/order_again/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}',  // Include CSRF token for Django
                            },
                            body: JSON.stringify({'order_number': orderNumber}),
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            location.reload();
                        })
                        .catch(error => {
                            console.error('Error ordering again:', error);
                        });
                    }
                }
            });
        });
   </script>
{% endblock %}
